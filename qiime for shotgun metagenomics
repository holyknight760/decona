(qiime2-metagenome-2024.5) holyknightt@SME189W2WDP030:/mnt/c/Wild_INU/decona$ qiime
assembly            demux               diversity-lib       feature-table       longitudinal        quality-control     sample-classifier   tools
composition         dev                 emperor             fondue              metadata            quality-filter      sapienns            vsearch
cutadapt            diversity           feature-classifier  info                moshpit             rescript            taxa
(qiime2-metagenome-2024.5) holyknightt@SME189W2WDP030:/mnt/c/Wild_INU/decona$ qiime moshpit
bin-contigs-metabat          collate-annotations          collate-sample-data-mags     fetch-diamond-db             filter-mags                  partition-orthologs
build-custom-diamond-db      collate-busco-results        dereplicate-mags             fetch-eggnog-db              get-feature-lengths          partition-sample-data-mags                                                                                                                                                         gs
build-eggnog-diamond-db      collate-feature-data-mags    eggnog-annotate              fetch-eggnog-proteins        inspect-kraken2-db           predict-genes-prodata-magsdigal                                                                                                                                                             digal
build-kraken-db              collate-kraken2-outputs      eggnog-diamond-search        fetch-kaiju-db               kraken2-to-features
classify-kaiju               collate-kraken2-reports      estimate-bracken             fetch-ncbi-taxonomy          kraken2-to-mag-features
classify-kraken2             collate-orthologs            evaluate-busco               filter-derep-mags            partition-feature-data-mags
(qiime2-metagenome-2024.5) holyknightt@SME189W2WDP030:/mnt/c/Wild_INU/decona$ qiime assembly 
Usage: qiime assembly [OPTIONS] COMMAND [ARGS]...

  Description: QIIME 2 plugin for (meta)genome assembly and quality control
  thereof.

  Plugin website: https://github.com/bokulich-lab/q2-assembly

  Getting user support: Please post to the QIIME 2 forum for help with this
  plugin: https://forum.qiime2.org

Options:
  --version              Show the version and exit.
  --example-data PATH    Write example data and exit.
  --citations            Show citations and exit.
  --show-hidden-actions  This plugin has hidden actions with names starting
                         with '_'. These are generally called internally by
                         pipelines. Passing this flag will display those
                         actions.
  --help                 Show this message and exit.

Commands:
  assemble-megahit      Assemble contigs using MEGAHIT.
  assemble-spades       Assemble contigs using SPAdes.
  collate-alignments    Map reads to contigs helper.
  collate-contigs       Collate contigs
  collate-indices       Collate indices
  evaluate-contigs      Evaluate quality of the assembled contigs using
                        metaQUAST.
bin-contigs-metabat          collate-annotations          collate-sample-data-mags     fetch-diamond-db             filter-mags                  partition-orthologs
build-custom-diamond-db      collate-busco-results        dereplicate-mags             fetch-eggnog-db              get-feature-lengths          partition-sample-data-mags
build-eggnog-diamond-db      collate-feature-data-mags    eggnog-annotate              fetch-eggnog-proteins        inspect-kraken2-db           predict-genes-prodigal
build-kraken-db              collate-kraken2-outputs      eggnog-diamond-search        fetch-kaiju-db               kraken2-to-features                           gs
classify-kaiju               collate-kraken2-reports      estimate-bracken             fetch-ncbi-taxonomy          kraken2-to-mag-features                       data-mags
classify-kraken2             collate-orthologs            evaluate-busco               filter-derep-mags            partition-feature-data-mags                 

* GRIDSS (needed for structural variants detection)
* SILVA 16S rRNA database (needed for reference genome detection in metagenomic datasets)
* BUSCO tools and databases (needed for searching BUSCO genes) -- works in Linux only!

To be able to use those, please run
    quast-download-gridss
    quast-download-silva
    quast-download-busco

$ conda activate qiime2-metagenome-2024.5

#NCBI database 제작 -> qiime으로 불러오기

#3ea seq test
$ time qiime tools import \
  --type 'FeatureData[Sequence]' \
  --input-path /mnt/c/Users/MSI/Downloads/3ea_sequence.fasta \
  --output-path 3ea_sequence.qza




#분석노트북
#(qiime2-metagenome-2024.5) holyknightt@DESKTOP-2PB6NR2:/mnt/d/qiime2/Database$
#<your working directory>
#├── moshpit
#│   ├── cache
#│   ├── results

$ mkdir -p moshpit/results

$ qiime tools cache-create \
  --cache ./moshpit/cache

$ qiime tools import \
  --type 'FeatureData[Sequence]' \
  --input-path /mnt/c/Users/MSI/Downloads/3ea_sequence.fasta \
  --output-path 3ea_sequence.qza

time qiime moshpit build-kraken-db \
--i-seqs ncbi_refseqs_18S_animals_plants_fungi_protists_v240630_seqs_derep_uniq.qza \
--o-kraken2-database ./moshpit/cache:kraken_18S_animals_plants_fungi_protists_v240630 \
--o-bracken-database ./moshpit/cache:bracken_18S_animals_plants_fungi_protists_v240630 \
--p-threads 12 \
--verbose

qiime moshpit classify-kraken2 \
	--i-seqs ./moshpit/cache:workshop-reads \
	--i-kraken2-db ./moshpit/cache:kracken_18S_animals_plants_fungi_protists_v240630 \
	--p-threads 40 \
	--p-confidence 0.6 \
	--p-minimum-base-quality 20 \
	--o-hits ./moshpit/cache:workshop_kraken_db_hits \
	--o-reports ./moshpit/cache:workshop_kraken_db_reports \
	--p-report-minimizer-data \
	--use-cache ./moshpit/cache \
	--parallel-config slurm_config.toml \
    	--verbose \
    	--p-memory-mapping False ##this was taking too much time for me





#ncbi_refseqs_18S_animals_plants_fungi_protists_v240630_seqs_derep_uniq
$ time qiime tools import \
  --type 'FeatureData[Sequence]' \
  --input-path /mnt/c/Users/MSI/Downloads/sequence_1_rm.fasta \
  --output-path ncbi_refseqs_18S_animals_plants_fungi_protists_v240630_seqs_derep_uniq.qza

#https://cap-lab.bio/q2-books/01-sra-data-access.html
(qiime2-metagenome-2024.5) holyknightt@DESKTOP-2PB6NR2:/mnt/d/qiime2/Database$ time qiime moshpit build-kraken-db \
--i-seqs ncbi_refseqs_18S_animals_plants_fungi_protists_v240630_seqs_derep_uniq.qza \
--output-dir kraken_db \
--p-threads 12 \
--verbose

time qiime tools import \
  --type 'SampleData[PairedEndSequencesWithQuality]' \
  --input-path /mnt/d/BaseSpace/240531_iWorkshop_NSQ2K_2024-05-31T03_16_48_446eaf1-420498082/BCL_Convert_-_FASTQ_Generation-738038352/Apo_L1-ds.96c658e771ab417eb99e0b1e7fd4b308 \
  --input-format CasavaOneEightSingleLanePerSampleDirFmt \
  --output-path demux-paired-end.qza

time qiime demux summarize \
 --i-data demux-paired-end.qza \
 --o-visualization demux 

#DADA2-Error: QIIME 2 has no plugin/command named 'dada2'.in qiime2-metagenome-2024.5 대신에 qiime2-amplicon-2024.5 버전에서 작업은 가능. but, 메모리 부족으로 code -9 에러 발생. 
time qiime dada2 denoise-paired \
--i-demultiplexed-seqs demux-paired-end.qza \
--p-trim-left-f 0 \
--p-trunc-len-f 143 \
--p-trim-left-r 0 \
--p-trunc-len-r 143 \
--p-max-ee-f 4.0 \
--p-max-ee-r 4.0 \
--p-min-overlap 4 \
--p-pooling-method independent \
--p-chimera-method consensus \
--p-n-threads 0 \
--o-table table.qza \
--o-representative-sequences representative_sequences.qza \
--o-denoising-stats denoising_stats.qza

time qiime vsearch merge-pairs \
--i-demultiplexed-seqs demux-paired-end.qza \
--o-merged-sequences demux-joined.qza \
--o-unmerged-sequences demux-unjoined.qza

#vserach 방식을 사용. for,rev 서열이 하나로 합쳐짐? 아니면 for만 수행됨. 따라서 이전에 merge-pairs를 수행해야 함. 
time qiime quality-filter q-score \
--i-demux demux-paired-end.qza \
--p-min-quality 20 \
--o-filtered-sequences primer_trimed_filtered.qza \
--o-filter-stats primer_trimed_filtered_stats \
--verbose
#Saved SampleData[SequencesWithQuality] to: primer_trimed_filtered.qza
#Saved QualityFilterStats to: primer_trimed_filtered_stats.qza
#real    223m36.072s

time qiime demux summarize \
--i-data primer_trimed_filtered.qza \
--o-visualization primer_trimed_filtered.qzv
#7m27.723s

time qiime metadata tabulate \
--m-input-file primer_trimed_filtered_stats.qza \
--o-visualization primer_trimed_filtered_stats.qzv 

Demultiplexing
time qiime vsearch dereplicate-sequences \
--i-sequences primer_trimed_filtered.qza \
--o-dereplicated-table primer_trimed_filtered_demulti_table \
--o-dereplicated-sequences primer_trimed_filtered_demulti_seq \
--verbose

qiime feature-table summarize \
--i-table primer_trimed_filtered_demulti_table.qza \
--o-visualization primer_trimed_filtered_demulti_table.qzv \
--verbose

qiime feature-table tabulate-seqs \
--i-data primer_trimed_filtered_demulti_seq.qza \
--o-visualization primer_trimed_filtered_demulti_seq.qzv 

Clustering
qiime vsearch cluster-features-de-novo \
--i-table primer_trimed_filtered_demulti_table.qza \
--i-sequences primer_trimed_filtered_demulti_seq.qza \
--p-perc-identity 0.98 \
--p-threads 32 \
--o-clustered-table table-dncluster98.qza \
--o-clustered-sequences rep-seqs-dncluster98.qza \
--verbose

qiime feature-table summarize \
--i-table table-dncluster98.qza \
--o-visualization table-dncluster98.qzv \
--verbose

qiime feature-table tabulate-seqs \
--i-data rep-seqs-dncluster98.qza \
--o-visualization rep-seqs-dncluster98.qzv

Chimera filtering
qiime vsearch uchime-denovo \
--i-table table-dncluster98.qza \
--i-sequences rep-seqs-dncluster98.qza \
--output-dir uchime-denovo-out \
--verbose

qiime metadata tabulate \
--m-input-file uchime-denovo-out/stats.qza \
--o-visualization uchime-denovo-out/stats.qvz \
--verbose

#Exclude chimeras but retain “borderline chimeras”
#https://docs.qiime2.org/2020.11/tutorials/chimera/
0m6.214s
time qiime feature-table filter-features \
  --i-table table-dncluster98.qza \
  --m-metadata-file uchime-denovo-out/chimeras.qza \
  --p-exclude-ids \
  --o-filtered-table uchime-denovo-out/table-nonchimer.qza \
  --verbose
Saved FeatureTable[Frequency] to: uchime-denovo-out/table-nonchimer.qza

0m6.693s
time qiime feature-table filter-seqs \
  --i-data rep-seqs-dncluster98.qza \
  --m-metadata-file uchime-denovo-out/chimeras.qza \
  --p-exclude-ids \
  --o-filtered-data uchime-denovo-out/rep-seqs-nonchimera_and_borderlinechimera.qza \
  --verbose
Saved FeatureData[Sequence] to: uchime-denovo-out/rep-seqs-nonchimera_and_borderlinechimera.qza

0m5.554s
time qiime feature-table summarize \
  --i-table uchime-denovo-out/table-nonchimer.qza \
  --o-visualization table-nonchimer.qzv \
  --verbose
Saved Visualization to: table-nonchimer_and_borderlinechimera.qzv

qiime feature-table tabulate-seqs \
--i-data uchime-denovo-out/rep-seqs-nonchimera_and_borderlinechimera.qza \
--output-dir chimera-denovo_clustering




time qiime moshpit classify-kraken2 \
	--i-seqs representative_sequences.qza \
	--i-kraken2-db /mnt/e/QIIME2/Database/kracken_db/kraken2_database.qza \
	--p-threads 40 \
	--p-confidence 0.6 \
	--p-minimum-base-quality 20 \
	--o-hits kraken_db_hits \
	--o-reports kraken_db_reports \
	--p-report-minimizer-data \
	--use-cache ./moshpit/cache \
	--parallel-config slurm_config.toml \
    	--verbose \
    	--p-memory-mapping False ##this was taking too much time for me


