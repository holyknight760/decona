#qiime feature-classifier classify-consensus-vsearch를 사용할 때 필요함. 
qiime tools import \
  --type 'FeatureData[Sequence]' \
  --input-path All_barcodes_combined.fasta \
  --output-path All_barcodes_combined.qza
#qiime taxa barplot 실시 가능 파일

#qiime vsearch dereplicate-sequences를 뒤에서 사용하려면 'SampleData[Sequences]' 폼이 필요함. 
time qiime tools import \
--type 'SampleData[Sequences]' \
--input-path All_barcodes_combined.fasta \
--output-path All_barcodes_combined_1.qza
qiime tools import \
  --type 'SampleData[Sequences]' \
  --input-path barcode17_concatenated.fasta \
  --output-path barcode17_concatenated_1.qza \
  --input-format DNAFASTAFormat

#추후 barplot분석을 위해 실행
Demultiplexing
qiime vsearch dereplicate-sequences \
--i-sequences All_barcodes_combined_1.qza \
--o-dereplicated-table primer_trimed_filtered_demulti_table \
--o-dereplicated-sequences primer_trimed_filtered_demulti_seq \
--verbose

qiime feature-classifier classify-consensus-blast \
 --i-query primer_trimed_filtered_demulti_seq.qza \
 --i-reference-reads /mnt/e/QIIME2/Database/ncbi-refseqs_18S_v220513-seqs-derep-uniq.qza \
 --i-reference-taxonomy /mnt/e/QIIME2/Database/ncbi-refseqs_18S_v220513-tax-derep-uniq.qza \
 --p-maxaccepts 1 \
 --p-perc-identity 0.95 \
 --p-min-consensus 0.75 \
 --p-query-cov 0.5 \
 --p-evalue 0.001 \
 --output-dir taxonomy
#QIIME 2에서 `--p-query-cov` 매개변수는 지정된 퍼센트 아이덴티티와 커버리지 이상의 히트 중에서 가장 높은 정렬 점수만을 유지하는 역할을 합니다. 
#따라서 `--p-query-cov 0.5`는 쿼리 시퀀스의 50% 이상이 데이터베이스 시퀀스와 일치할 때만 해당 히트를 유지하라는 의미입니다. 
#이는 잘못된 분류를 방지하고 정확도를 높이는 데 도움이 됩니다. 

qiime feature-classifier classify-consensus-blast \
 --i-query primer_trimed_filtered_demulti_seq.qza \
 --i-reference-reads /mnt/e/QIIME2/Database/ncbi-refseqs-1720ea_v2-seqs_18S_v230131-derep-uniq.qza \
 --i-reference-taxonomy /mnt/e/QIIME2/Database/ncbi-refseqs-taxonomy-1720ea_v2-tax_18S_v230131-derep-uniq.qza \
 --p-maxaccepts 1 \
 --p-perc-identity 0.95 \
 --p-min-consensus 0.75 \
 --p-query-cov 0.5 \
 --p-evalue 0.001 \
 --output-dir taxonomy

qiime feature-classifier classify-consensus-blast \
 --i-query primer_trimed_filtered_demulti_seq.qza \
 --i-reference-reads /mnt/e/QIIME2/Database/ncbi-refseqs-1720ea_v2-seqs_18S_v230131-derep-uniq.qza \
 --i-reference-taxonomy /mnt/e/QIIME2/Database/ncbi-refseqs-taxonomy-1720ea_v2-tax_18S_v230131-derep-uniq.qza \
 --p-maxaccepts 1 \
 --p-perc-identity 0.95 \
 --p-min-consensus 0.75 \
 --p-query-cov 0.1 \
 --p-evalue 0.1 \
 --output-dir taxonomy

Barplot
qiime taxa barplot \
--i-table primer_trimed_filtered_demulti_table.qza \
--i-taxonomy /mnt/e/Nanopore/parasite_18S/max1_percid0.95_mincon0.75_querycov0.1_pvalue0.1/taxonomy/classification.qza \
--o-visualization bar_plots_blast95_18S-asv.qzv 

qiime metadata tabulate \
--m-input-file /mnt/e/Nanopore/parasite_18S/taxonomy/classification.qza \
--m-input-file primer_trimed_filtered_demulti_seq.qza \
--o-visualization taxonomy_consensus_blast-asv.qzv

Building a tree
qiime phylogeny align-to-tree-mafft-fasttree \
--i-sequences primer_trimed_filtered_demulti_seq.qza \
--output-dir tree

qiime feature-table summarize \
--i-table primer_trimed_filtered_demulti_table.qza \
--o-visualization denoise-table.qzv 

time qiime diversity alpha-rarefaction \
--i-table primer_trimed_filtered_demulti_table.qza \
--i-phylogeny tree/rooted_tree.qza \
--p-max-depth 553 \
--m-metadata-file metadata_18s.tsv \
--o-visualization alpha_rarefaction-max-depth553.qzv \
--verbose






